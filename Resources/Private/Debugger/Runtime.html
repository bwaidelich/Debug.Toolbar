<f:layout name="Default" />

<f:section name="Widget">
<div class="block">
	<div class="block-icon">
		<img width="16" height="28" alt="Time" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAcCAYAAABoMT8aAAABqUlEQVR42t2Vv0sCYRyHX9OmEhsMx/YKGlwLQ69DTEUSBJEQEy5J3FRc/BsuiFqEIIcQIRo6ysUhoaBBWhoaGoJwiMJLglRKrs8bXgienmkQdPDAwX2f57j3fhFJkkbiPwTK5bIiFoul3kmPud8MqKMewDXpwuGww+12n9hsNhFnlijYf/Z4PDmO45Yxo+10ZFGTyWRMEItU6AdCx7lczkgd6n7J2Wx2xm63P6jJMk6n80YQBBN1aUDv9XqvlAbbm2LE7/cLODRB0un0VveAeoDC8/waCQQC18MGQqHQOcEKvw8bcLlcL6TfYnVtCrGRAlartUUYhmn1jKg/E3USjUYfhw3E4/F7ks/nz4YNFIvFQ/ogbUYikdefyqlU6gnuOg2YK5XKvs/n+xhUDgaDTVEUt+HO04ABOBA5isViDTU5kUi81Wq1AzhWMEkDGmAEq2C3UCjcYXGauDvfEsuyUjKZbJRKpVvM8IABU9SVX+cxYABmwIE9cFqtVi9xtgvsC2AHbIAFoKey0gdlHEyDObAEWLACFsEsMALdIJ80+dK0bTS95v7+v/AJnis0eO906QwAAAAASUVORK5CYII=">
		{runtime} ms
	</div>
	<div class="block-popup">
		<table>
			<tr>
				<th>Runtime</th>
				<td>{runtime}</td>
			</tr>
		</table>
	</div>
</div>
</f:section>

<f:section name="Button">
	
</f:section>

<f:section name="Panel">
	<table>
		<tr>
			<th>Runtime</th>
			<td>{runtime}</td>
		</tr>
	</table>

<!-- 	<table>
		<f:for each="{durations}" as="duration" key="name">
		<tr>
			<th>{name}</th>
			<td>{duration.time}</td>
		</tr>
		</f:for>
	</table> -->

	<div id="body"></div>

    <link type="text/css" rel="stylesheet" href="{f:uri.resource(path: 'D3/d3.css', package: 'Debug.Toolbar')}"/>
    <script type="text/javascript" src="{f:uri.resource(path: 'D3/d3.js', package: 'Debug.Toolbar')}"></script>
    <script type="text/javascript" src="{f:uri.resource(path: 'D3/d3.layout.js', package: 'Debug.Toolbar')}"></script>
    <style type="text/css">
		.chart {
		  display: block;
		  margin: auto;
		  margin-top: 40px;
		}

		text {
		  font-size: 11px;
		}

		rect {
		  fill: none;
		}

    </style>
    <script type="text/javascript">
    	var data = eval('(' + '{data -> f:format.raw()}' + ')');
    	function blockDiagram(data){
			var w = 800,
			    h = 800 - 180,
			    x = d3.scale.linear().range([0, w]),
			    y = d3.scale.linear().range([0, h]),
			    color = d3.scale.category20c(),
			    root,
			    node;

			var treemap = d3.layout.treemap()
			    .round(false)
			    .size([w, h])
			    .sticky(true)
			    .value(function(d) { return d.size; });

			var svg = d3.select("#body").append("div")
			    .attr("class", "chart")
			    .style("width", w + "px")
			    .style("height", h + "px")
			  .append("svg:svg")
			    .attr("width", w)
			    .attr("height", h)
			  .append("svg:g")
			    .attr("transform", "translate(.5,.5)");

			  node = root = data;

			  var nodes = treemap.nodes(root)
			      .filter(function(d) { return !d.children; });
			  var cell = svg.selectAll("g")
			      .data(nodes)
			    .enter().append("svg:g")
			      .attr("class", "cell")
			      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
			      .on("click", function(d) { return zoom(node == d.parent ? root : d.parent); });

			  cell.append("svg:rect")
			      .attr("width", function(d) { return d.dx - 1; })
			      .attr("height", function(d) { return d.dy - 1; })
			      .style("fill", function(d) { return color(d.parent.name); });

			  cell.append("svg:text")
			      .attr("x", function(d) { return d.dx / 2; })
			      .attr("y", function(d) { return d.dy / 2; })
			      .attr("dy", ".35em")
			      .attr("text-anchor", "middle")
			      .text(function(d) { return d.name + " (" + d.time + " ms)"; })
			      .style("opacity", function(d) { d.w = this.getComputedTextLength(); return d.dx > d.w * 0.5 ? 1 : 0; });

			  d3.select(window).on("click", function() { zoom(root); });

			  d3.select("select").on("change", function() {
			    treemap.value(this.value == "size" ? size : count).nodes(root);
			    zoom(node);
			  });

			function size(d) {
			  return d.size;
			}

			function count(d) {
			  return 1;
			}

			function zoom(d) {
			  var kx = w / d.dx, ky = h / d.dy;
			  x.domain([d.x, d.x + d.dx]);
			  y.domain([d.y, d.y + d.dy]);

			  var t = svg.selectAll("g.cell").transition()
			      .duration(d3.event.altKey ? 7500 : 750)
			      .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

			  t.select("rect")
			      .attr("width", function(d) { return kx * d.dx - 1; })
			      .attr("height", function(d) { return ky * d.dy - 1; })

			  t.select("text")
			      .attr("x", function(d) { return kx * d.dx / 2; })
			      .attr("y", function(d) { return ky * d.dy / 2; })
			      .style("opacity", function(d) { return kx * d.dx > d.w ? 1 : 0; });

			  node = d;
			  d3.event.stopPropagation();
			}
		}

		function barDiagram(data) {
			var m = [80, 160, 0, 200], // top right bottom left
			    w = 800 - m[1] - m[3], // width
			    h = 800 - m[0] - m[2], // height
			    x = d3.scale.linear().range([0, w]),
			    y = 25, // bar height
			    z = d3.scale.ordinal().range(["steelblue", "#aaa"]); // bar color

			var hierarchy = d3.layout.partition()
			    .value(function(d) { return d.size; });

			var xAxis = d3.svg.axis()
			    .scale(x)
			    .orient("top");

			var svg = d3.select("#body").append("svg:svg")
			    .attr("width", w + m[1] + m[3])
			    .attr("height", h + m[0] + m[2])
			  .append("svg:g")
			    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

			svg.append("svg:rect")
			    .attr("class", "background")
			    .attr("width", w)
			    .attr("height", h)
			    .on("click", up);

			svg.append("svg:g")
			    .attr("class", "x axis");

			svg.append("svg:g")
			    .attr("class", "y axis")
			  .append("svg:line")
			    .attr("y1", "100%");

			function init(root){
			  hierarchy.nodes(root);
			  x.domain([0, root.value]).nice();
			  down(root, 0);
			}
			init(data);

			function down(d, i) {
			  if (!d.children || this.__transition__) return;
			  var duration = d3.event && d3.event.altKey ? 7500 : 750,
			      delay = duration / d.children.length;

			  // Mark any currently-displayed bars as exiting.
			  var exit = svg.selectAll(".enter").attr("class", "exit");

			  // Entering nodes immediately obscure the clicked-on bar, so hide it.
			  exit.selectAll("rect").filter(function(p) { return p === d; })
			      .style("fill-opacity", 1e-6);

			  // Enter the new bars for the clicked-on data.
			  // Per above, entering bars are immediately visible.
			  var enter = bar(d)
			      .attr("transform", stack(i))
			      .style("opacity", 1);

			  // Have the text fade-in, even though the bars are visible.
			  // Color the bars as parents; they will fade to children if appropriate.
			  enter.select("text").style("fill-opacity", 1e-6);
			  enter.select("rect").style("fill", z(true));

			  // Update the x-scale domain.
			  x.domain([0, d3.max(d.children, function(d) { return d.value; })]).nice();

			  // Update the x-axis.
			  svg.selectAll(".x.axis").transition()
			      .duration(duration)
			      .call(xAxis);

			  // Transition entering bars to their new position.
			  var enterTransition = enter.transition()
			      .duration(duration)
			      .delay(function(d, i) { return i * delay; })
			      .attr("transform", function(d, i) { return "translate(0," + y * i * 1.2 + ")"; });

			  // Transition entering text.
			  enterTransition.select("text").style("fill-opacity", 1);

			  // Transition entering rects to the new x-scale.
			  enterTransition.select("rect")
			      .attr("width", function(d) { return x(d.value); })
			      .style("fill", function(d) { return z(!!d.children); });

			  // Transition exiting bars to fade out.
			  var exitTransition = exit.transition()
			      .duration(duration)
			      .style("opacity", 1e-6)
			      .remove();

			  // Transition exiting bars to the new x-scale.
			  exitTransition.selectAll("rect").attr("width", function(d) { return x(d.value); });

			  // Rebind the current node to the background.
			  svg.select(".background").data([d]).transition().duration(duration * 2); d.index = i;
			}

			function up(d) {
			  if (!d.parent || this.__transition__) return;
			  var duration = d3.event && d3.event.altKey ? 7500 : 750,
			      delay = duration / d.children.length;

			  // Mark any currently-displayed bars as exiting.
			  var exit = svg.selectAll(".enter").attr("class", "exit");

			  // Enter the new bars for the clicked-on data's parent.
			  var enter = bar(d.parent)
			      .attr("transform", function(d, i) { return "translate(0," + y * i * 1.2 + ")"; })
			      .style("opacity", 1e-6);

			  // Color the bars as appropriate.
			  // Exiting nodes will obscure the parent bar, so hide it.
			  enter.select("rect")
			      .style("fill", function(d) { return z(!!d.children); })
			    .filter(function(p) { return p === d; })
			      .style("fill-opacity", 1e-6);

			  // Update the x-scale domain.
			  x.domain([0, d3.max(d.parent.children, function(d) { return d.value; })]).nice();

			  // Update the x-axis.
			  svg.selectAll(".x.axis").transition()
			      .duration(duration * 2)
			      .call(xAxis);

			  // Transition entering bars to fade in over the full duration.
			  var enterTransition = enter.transition()
			      .duration(duration * 2)
			      .style("opacity", 1);

			  // Transition entering rects to the new x-scale.
			  // When the entering parent rect is done, make it visible!
			  enterTransition.select("rect")
			      .attr("width", function(d) { return x(d.value); })
			      .each("end", function(p) { if (p === d) d3.select(this).style("fill-opacity", null); });

			  // Transition exiting bars to the parent's position.
			  var exitTransition = exit.selectAll("g").transition()
			      .duration(duration)
			      .delay(function(d, i) { return i * delay; })
			      .attr("transform", stack(d.index));

			  // Transition exiting text to fade out.
			  exitTransition.select("text")
			      .style("fill-opacity", 1e-6);

			  // Transition exiting rects to the new scale and fade to parent color.
			  exitTransition.select("rect")
			      .attr("width", function(d) { return x(d.value); })
			      .style("fill", z(true));

			  // Remove exiting nodes when the last child has finished transitioning.
			  exit.transition().duration(duration * 2).remove();

			  // Rebind the current parent to the background.
			  svg.select(".background").data([d.parent]).transition().duration(duration * 2);
			}

			// Creates a set of bars for the given data node, at the specified index.
			function bar(d) {
			  var bar = svg.insert("svg:g", ".y.axis")
			      .attr("class", "enter")
			      .attr("transform", "translate(0,5)")
			    .selectAll("g")
			      .data(d.children)
			    .enter().append("svg:g")
			      .style("cursor", function(d) { return !d.children ? null : "pointer"; })
			      .on("click", down);

			  bar.append("svg:text")
			      .attr("x", -6)
			      .attr("y", y / 2)
			      .attr("dy", ".35em")
			      .attr("text-anchor", "end")
			      .text(function(d) { return d.name + " (" + d.time + " ms)"; });

			  bar.append("svg:rect")
			      .attr("width", function(d) { return x(d.value); })
			      .attr("height", y);

			  return bar;
			}

			// A stateful closure for stacking bars horizontally.
			function stack(i) {
			  var x0 = 0;
			  return function(d) {
			    var tx = "translate(" + x0 + "," + y * i * 1.2 + ")";
			    x0 += x(d.value);
			    return tx;
			  };
			}
		}

		barDiagram(data);

    </script>
</f:section>